# Управление пользователями

Скрипты для создания, модификации и удаления пользователей сети **Sigil Gate**.

## Скрипты

### `create.sh` [атомарный]

Создание записи пользователя в хранилище.

```bash
./users/create.sh --username "Ivan" --core-node 202.223.48.9
```

Необязательные параметры:

| Параметр | Описание | Валидация |
|----------|----------|-----------|
| `--email` | Email пользователя | Формат `*@*.*` |
| `--telegram` | Telegram username | Начинается с `@` |
| `--telegram-id` | Числовой Telegram ID | Положительное целое число |
| `--hash` | Хеш пароля | Любая строка |

Выводит ID созданного пользователя в stdout.

Валидация:
- Уникальность username среди всех пользователей
- Существование и активность Core-ноды
- Наличие и активность роли `core` у указанной ноды

### `add.sh` [оркестратор]

Полный цикл создания пользователя: `create.sh` → `store/commit.sh`.

```bash
./users/add.sh --username "Ivan" --core-node 202.223.48.9 [--email ...] [--telegram ...] [--telegram-id ...] [--hash ...]
```

### `modify.sh` [атомарный]

Модификация полей записи пользователя. Можно передать несколько полей за один вызов.

```bash
./users/modify.sh --id 1 --telegram "@new_tg" --telegram-id 123456789
./users/modify.sh --id 1 --status archived
./users/modify.sh --id 1 --email ""          # сброс в null
```

Модифицируемые поля:

| Поле | Валидация | Пустое значение |
|------|-----------|-----------------|
| `--username` | Уникальность, непустое | — |
| `--status` | `active` или `archived` | — |
| `--email` | Формат `*@*.*` | Сброс в `null` |
| `--telegram` | Начинается с `@` | Сброс в `null` |
| `--telegram-id` | Положительное целое число | Сброс в `null` |
| `--hash` | Любая строка | Сброс в `null` |

### `update.sh` [оркестратор]

Полный цикл модификации пользователя: `modify.sh` → `store/commit.sh`.

```bash
./users/update.sh --id 1 --telegram "@new_tg" --telegram-id 123456789
```

Сообщение коммита формируется автоматически с перечислением измененных полей.

### `delete.sh` [атомарный]

Физическое удаление записи пользователя из хранилища.

```bash
./users/delete.sh --id 1
```

- Проверка безопасности: отказ если существуют устройства пользователя (с выводом списка)
- Идемпотентно: exit 0 если файл не существует
- Выводит username в stdout

### `remove.sh` [оркестратор]

Полный цикл удаления пользователя со всеми устройствами.

```bash
./users/remove.sh --id 1
```

Последовательность:
1. Для каждого устройства пользователя — снятие с Entry-нод (`entry/remove-client.sh`)
2. Удаление файлов устройств (`devices/delete.sh`)
3. Удаление файла пользователя (`users/delete.sh`)
4. Один коммит на весь цикл (`store/commit.sh`)

Ошибки отдельных Entry-нод не останавливают процесс — скрипт продолжает и выводит итоговый счетчик ошибок.
