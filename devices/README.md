# Управление устройствами

Скрипты для создания, модификации и удаления клиентских устройств пользователей **Sigil Gate**.

Устройство — это клиентское подключение (телефон, ноутбук и т.д.), идентифицируемое по UUID. При добавлении устройство регистрируется в хранилище и применяется на всех Entry-нодах пользователя.

## Скрипты

### `create.sh` [атомарный]

Создание записи устройства в хранилище.

```bash
./devices/create.sh --user 1 --device "mobile_006"
```

- Проверяет существование и активность пользователя
- Генерирует UUID
- Выводит UUID в stdout

### `add.sh` [оркестратор]

Полный цикл добавления устройства: создание в хранилище → коммит → применение на Entry-нодах.

```bash
./devices/add.sh --user 1 --device "mobile_006"
```

Последовательность:
1. Создание записи (`devices/create.sh`)
2. Коммит (`store/commit.sh`)
3. Для каждого маршрута через Core-ноды пользователя — добавление на Entry-ноду (`entry/add-client.sh`)
4. Вывод UUID и VLESS-ссылок

### `modify.sh` [атомарный]

Модификация полей записи устройства. Можно передать несколько полей за один вызов.

```bash
./devices/modify.sh --uuid <UUID> --device "new_name"
./devices/modify.sh --uuid <UUID> --status archived
./devices/modify.sh --uuid <UUID> --device "new_name" --status archived
```

Модифицируемые поля:

| Поле | Валидация |
|------|-----------|
| `--device` | Непустое |
| `--status` | `active` или `archived` |

### `update.sh` [оркестратор]

Полный цикл модификации устройства: `modify.sh` → `store/commit.sh`.

```bash
./devices/update.sh --uuid <UUID> --device "new_name"
```

Сообщение коммита формируется автоматически с перечислением измененных полей.

### `delete.sh` [атомарный]

Физическое удаление записи устройства из хранилища.

```bash
./devices/delete.sh --uuid <UUID>
```

- Идемпотентно: exit 0 если файл не существует
- Не трогает Entry-ноды (это ответственность оркестратора)
- Выводит имя устройства в stdout

### `remove.sh` [оркестратор]

Полный цикл удаления устройства: снятие с Entry-нод → удаление записи → коммит.

```bash
./devices/remove.sh --uuid <UUID>
```

Последовательность:
1. Снятие с Entry-нод через маршруты Core-нод пользователя (`entry/remove-client.sh`)
2. Удаление файла устройства (`devices/delete.sh`)
3. Коммит (`store/commit.sh`)

Ошибки отдельных Entry-нод не останавливают процесс.
