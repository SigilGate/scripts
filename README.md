# Скрипты автоматизации **Sigil Gate**

Набор bash-скриптов для автоматизации типовых операций с инфраструктурой **Sigil Gate**.

## Место в системе

Скрипты запускаются с Core-ноды и работают с:

- **Локальным хранилищем данных** — клон приватного репозитория с JSON-описанием инфраструктуры (ноды, пользователи, устройства, маршруты, домены, роли).
- **Entry-нодами** — по SSH для применения конфигураций (Xray, Nginx).

Хранилище данных представляет собой git-репозиторий с JSON-файлами. Каждая директория — сущность, каждый файл — экземпляр. Скрипты читают данные из хранилища, вносят изменения и коммитят их (без push). Синхронизация с удаленным репозиторием — отдельный процесс по таймеру.

## Требования

- bash 4+
- jq
- uuidgen (или `/proc/sys/kernel/random/uuid`)
- SSH-доступ к Entry-нодам (по ключу)
- Клон хранилища данных на Core-ноде

## Настройка

Задайте переменные окружения (или создайте файл `.env` по образцу `.env.example`):

```bash
# Путь к локальному хранилищу данных
SIGIL_STORE_PATH=/home/sigil/store

# SSH-доступ к Entry-нодам
SIGIL_SSH_KEY=/home/sigil/.ssh/id_rsa
SIGIL_SSH_USER=sigil
SIGIL_SSH_PASSWORD=<password>
```

## Архитектура

### Два типа скриптов

**Атомарные** — выполняют одно действие, компактные, переиспользуемые. Предназначены для вызова из оркестраторов или вручную.

**Оркестраторы** — собирают цепочку атомарных скриптов для конкретного сценария.

### Общая библиотека

`lib/common.sh` — логирование, валидация окружения, SSH-обертки, генерация UUID, разбор аргументов. Подключается в каждом скрипте через `source`.

### Принципы

- `set -euo pipefail` — строгая обработка ошибок
- Именованные аргументы (`--user`, `--device`)
- Валидация входных данных перед любым действием
- Идемпотентность — повторный запуск безопасен
- Без хардкода — все из переменных окружения или аргументов
- Атомарный коммит каждого изменения в хранилище (без push)
- Никаких секретов в коде — IP, домены, UUID, пароли только через окружение и хранилище

## Доступные скрипты

### Управление устройствами

**`devices/add.sh`** [оркестратор] — полный цикл добавления устройства:

```bash
./devices/add.sh --user 1 --device "mobile_006"
```

Создает запись в хранилище, коммитит, добавляет клиента на все Entry-ноды пользователя, выводит VLESS-ссылки.

**`devices/create.sh`** [атомарный] — создание записи устройства в хранилище:

```bash
./devices/create.sh --user 1 --device "mobile_006"
```

### Управление Entry-нодами

**`entry/add-client.sh`** [атомарный] — добавление клиента в Xray на одной Entry-ноде:

```bash
./entry/add-client.sh --host <IP> --uuid <UUID> --service-name <SERVICE_NAME> --name <LABEL>
```

### Хранилище

**`store/commit.sh`** [атомарный] — коммит изменений в хранилище (без push):

```bash
./store/commit.sh --message "Add device mobile_006 for user AlexMa"
```

## Структура

```
scripts/
├── README.md
├── .env.example
├── .gitignore
├── lib/
│   └── common.sh           # Общая библиотека
├── store/
│   └── commit.sh           # Коммит изменений в хранилище
├── devices/
│   ├── create.sh           # [атомарный] Создать запись устройства
│   └── add.sh              # [оркестратор] Добавить устройство
└── entry/
    └── add-client.sh       # [атомарный] Добавить клиента в Xray
```

## Дорожная карта

1. **Управление устройствами** — add, remove ← текущий этап
2. **Синхронизация хранилища** — push по таймеру, разрешение коллизий
3. **Ротация путей** — автоматическая ротация gRPC serviceName
4. **Подготовка нод** — автоматизация provision-процедур
5. **Управление Xray/Nginx** — конфигурация сервисов
6. **Python-приложение** — оркестрация всех операций, веб-интерфейс
