# Операции с хранилищем

Скрипты для управления git-хранилищем данных **Sigil Gate**.

## Скрипты

### `commit.sh` [атомарный]

Коммит всех изменений в хранилище (без push).

```bash
./store/commit.sh --message "Add device mobile_006 for user AlexMa"
```

Последовательность:
1. `git add -A` — индексация всех изменений
2. Проверка наличия изменений (`git diff --cached --quiet`)
3. `git commit` с переданным сообщением

Идемпотентно: exit 0 если нет изменений для коммита. Push на удалённый репозиторий — отдельный процесс.

---

### `push.sh` [атомарный]

Отправка локальных изменений registry на GitHub. Вызывается автоматически из `core/sync.sh` каждые 15 минут.

```bash
./store/push.sh
```

**Переменные окружения:**

| Переменная | Обязательная | Описание |
|------------|-------------|----------|
| `SIGIL_STORE_PATH` | да | Путь к локальному клону registry |

#### Логика синхронизации

```
git fetch origin
        │
        ├─ local == remote ──────────────────► exit 0 (ничего делать не надо)
        │
        ├─ только local впереди ─────────────► git push → exit 0
        │
        ├─ только remote впереди ────────────► (push не нужен, pull — задача pull-scripts) → exit 0
        │
        └─ оба впереди (расхождение)
                │
                ├─ git pull --rebase ──► успех ──► git push → exit 0
                │
                └─ rebase не удался
                        │
                        ├─ git rebase --abort
                        ├─ записать logs/sync-conflict-<TIMESTAMP>.md
                        ├─ git commit (conflict log)
                        ├─ git push --force-with-lease  (Core wins)
                        └─ exit 1
```

#### Стратегия при конфликте

Rebase — штатный путь для репозитория, где большинство изменений вносятся на Core. Если оба источника изменили **разные файлы** (разные пользователи, устройства), rebase завершится автоматически без конфликтов.

Реальный конфликт возникает, только если оба источника изменили **один и тот же файл**. В этом случае:

1. Rebase прерывается (`git rebase --abort`) — репозиторий возвращается в исходное состояние.
2. В директорию `logs/` registry записывается файл `sync-conflict-<TIMESTAMP>.md` с деталями:
   - SHA локальной и remote-ветвей
   - Список коммитов с обеих сторон
   - Список файлов с расхождениями
3. Лог-файл коммитится и отправляется на GitHub через `git push --force-with-lease`.
4. **Локальные изменения побеждают (Core wins).** Remote-изменения теряются, но зафиксированы в лог-файле.
5. Скрипт завершается с exit code 1 — оркестратор фиксирует ошибку в systemd journal.

Администратор видит появление файла `logs/sync-conflict-*.md` в репозитории GitHub и предпринимает необходимые действия.
